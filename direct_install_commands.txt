# === Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ===

# 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…
sudo apt update -y && sudo apt upgrade -y

# 2. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
sudo apt install -y wget curl git unzip python3 python3-pip python3-venv postgresql postgresql-contrib nginx ffmpeg build-essential pkg-config

# 3. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
cd /home/eg2
sudo rm -rf ai-translator 2>/dev/null
wget -O ai-translator.zip https://github.com/AbdelmonemAwad/ai-translator/archive/refs/heads/main.zip
unzip ai-translator.zip
mv ai-translator-main ai-translator
rm ai-translator.zip
cd ai-translator

# 4. Ø¥Ø¹Ø¯Ø§Ø¯ Python
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install flask flask-sqlalchemy gunicorn psycopg2-binary requests psutil pynvml email-validator werkzeug sendgrid

# 5. Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
sudo -u postgres createuser -s ai_translator 2>/dev/null || true
sudo -u postgres createdb ai_translator 2>/dev/null || true
sudo -u postgres psql -c "ALTER USER ai_translator WITH PASSWORD 'ai_translator_pass2024';"

# 6. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
cat > .env << EOF
DATABASE_URL=postgresql://ai_translator:ai_translator_pass2024@localhost/ai_translator
PGHOST=localhost
PGPORT=5432
PGUSER=ai_translator
PGPASSWORD=ai_translator_pass2024
PGDATABASE=ai_translator
SESSION_SECRET=$(openssl rand -hex 32)
FLASK_APP=main.py
FLASK_ENV=production
EOF

# 7. ØªØ´ØºÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
source .env
python3 database_setup.py

# 8. Ø¥Ø¶Ø§ÙØ© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
mkdir -p static/js
cat > static/js/final-tabs-fix.js << 'EOF'
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ Final tabs fix loading...');
    
    setTimeout(initializeTabs, 500);
    
    function initializeTabs() {
        const categorySelect = document.getElementById('category-select');
        const subcategorySelect = document.getElementById('subcategory-select');
        
        if (!categorySelect || !subcategorySelect) {
            console.error('âŒ Tab controls not found');
            return;
        }
        
        const categoryMapping = {
            'general': [
                { id: 'DEFAULT', name: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© / Basic Settings' }
            ],
            'ai': [
                { id: 'WHISPER', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Whisper' },
                { id: 'OLLAMA', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ollama' },
                { id: 'API', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API / API Settings' }
            ],
            'media': [
                { id: 'PLEX', name: 'Plex Media Server' },
                { id: 'JELLYFIN', name: 'Jellyfin Media Server' },
                { id: 'RADARR', name: 'Radarr (Ø£ÙÙ„Ø§Ù… / Movies)' },
                { id: 'SONARR', name: 'Sonarr (Ù…Ø³Ù„Ø³Ù„Ø§Øª / TV Shows)' }
            ],
            'system': [
                { id: 'PATHS', name: 'Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª / File Paths' },
                { id: 'SERVER', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… / Server Settings' }
            ]
        };
        
        function hideAllTabs() {
            document.querySelectorAll('.tab-content, [id^="tab-"]').forEach(tab => {
                tab.classList.add('hidden');
                tab.style.display = 'none';
            });
        }
        
        function showTabContent(sectionId) {
            console.log('ğŸ‘ï¸ Showing content for section:', sectionId);
            hideAllTabs();
            
            const targetTab = document.getElementById('tab-' + sectionId);
            if (targetTab) {
                targetTab.classList.remove('hidden');
                targetTab.style.display = 'block';
                targetTab.style.visibility = 'visible';
                console.log('âœ… Successfully showed:', sectionId);
                return true;
            }
            return false;
        }
        
        function populateSubcategories(categoryKey) {
            subcategorySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ / Choose Subcategory</option>';
            
            const sections = categoryMapping[categoryKey] || [];
            sections.forEach(section => {
                const targetTab = document.getElementById('tab-' + section.id);
                if (targetTab) {
                    const option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = section.name;
                    subcategorySelect.appendChild(option);
                }
            });
            
            subcategorySelect.disabled = false;
            
            if (sections.length > 0) {
                const firstAvailable = sections.find(section => 
                    document.getElementById('tab-' + section.id)
                );
                if (firstAvailable) {
                    subcategorySelect.value = firstAvailable.id;
                    showTabContent(firstAvailable.id);
                }
            }
        }
        
        categorySelect.addEventListener('change', function() {
            populateSubcategories(this.value);
        });
        
        subcategorySelect.addEventListener('change', function() {
            if (this.value) {
                showTabContent(this.value);
            }
        });
        
        window.switchCategory = () => categorySelect.dispatchEvent(new Event('change'));
        window.switchTab = () => subcategorySelect.dispatchEvent(new Event('change'));
        
        if (categorySelect.value) {
            populateSubcategories(categorySelect.value);
        } else {
            categorySelect.value = 'general';
            populateSubcategories('general');
        }
        
        console.log('âœ… Final tabs fix initialized successfully');
    }
});
EOF

# 9. ØªØ­Ø¯ÙŠØ« layout.html
if [[ -f "templates/layout.html" ]]; then
    if ! grep -q "final-tabs-fix.js" templates/layout.html; then
        sed -i 's|</body>|    <script src="{{ url_for('\''static'\'', filename='\''js/final-tabs-fix.js'\'') }}"></script>\n</body>|' templates/layout.html
        echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« layout.html"
    fi
fi

# 10. Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø© systemd
sudo tee /etc/systemd/system/ai-translator.service > /dev/null << 'SERVICE_EOF'
[Unit]
Description=AI Translator Service
After=network.target postgresql.service

[Service]
Type=simple
User=eg2
WorkingDirectory=/home/eg2/ai-translator
Environment=PATH=/home/eg2/ai-translator/venv/bin
EnvironmentFile=/home/eg2/ai-translator/.env
ExecStart=/home/eg2/ai-translator/venv/bin/gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 300 main:app
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
SERVICE_EOF

# 11. Ø¥Ø¹Ø¯Ø§Ø¯ Nginx
sudo tee /etc/nginx/sites-available/ai-translator > /dev/null << 'NGINX_EOF'
server {
    listen 80;
    server_name _;
    
    client_max_body_size 2G;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
    }
    
    location /static/ {
        alias /home/eg2/ai-translator/static/;
        expires 30d;
    }
}
NGINX_EOF

sudo ln -sf /etc/nginx/sites-available/ai-translator /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# 12. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
sudo chown -R eg2:eg2 /home/eg2/ai-translator
sudo systemctl daemon-reload
sudo systemctl enable ai-translator
sudo systemctl restart nginx
sudo systemctl start ai-translator

# 13. ÙØ­Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
sleep 3
echo ""
echo "ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª:"
echo "AI Translator: $(systemctl is-active ai-translator)"
echo "Nginx: $(systemctl is-active nginx)"
echo "PostgreSQL: $(systemctl is-active postgresql)"

local_ip=$(hostname -I | awk '{print $1}')
echo ""
echo "ğŸ‰ ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­!"
echo "ğŸŒ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: http://$local_ip"
echo "ğŸŒ Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ: http://mocd01.synology.me"
echo "ğŸ”‘ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin"
echo "ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: your_strong_password"

# === Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª ===
