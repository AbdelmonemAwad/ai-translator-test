# Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ AI Translator v2.2.4
# Ù„Ù„ØªÙ†ÙÙŠØ° Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…: 5.31.55.179

# === Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… ===
# ssh eg2@5.31.55.179
# ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: 1q1

# === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… ===
sudo apt update -y && sudo apt upgrade -y

# === ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===
sudo apt install -y wget curl git unzip python3 python3-pip python3-venv postgresql postgresql-contrib nginx ffmpeg build-essential pkg-config software-properties-common apt-transport-https ca-certificates

# === ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ===
cd /home/eg2
sudo rm -rf ai-translator 2>/dev/null
wget -O ai-translator.zip https://github.com/AbdelmonemAwad/ai-translator/archive/refs/heads/main.zip
unzip ai-translator.zip
mv ai-translator-main ai-translator
rm ai-translator.zip
cd ai-translator

# === Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ===
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install flask flask-sqlalchemy gunicorn psycopg2-binary requests psutil pynvml email-validator werkzeug sendgrid

# === Ø¥Ø¹Ø¯Ø§Ø¯ PostgreSQL ===
sudo systemctl start postgresql
sudo systemctl enable postgresql
sudo -u postgres createuser -s ai_translator 2>/dev/null || true
sudo -u postgres createdb ai_translator 2>/dev/null || true
sudo -u postgres psql -c "ALTER USER ai_translator WITH PASSWORD 'ai_translator_pass2024';"

# === Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© ===
cat > .env << 'ENV_EOF'
DATABASE_URL=postgresql://ai_translator:ai_translator_pass2024@localhost/ai_translator
PGHOST=localhost
PGPORT=5432
PGUSER=ai_translator
PGPASSWORD=ai_translator_pass2024
PGDATABASE=ai_translator
SESSION_SECRET=$(openssl rand -hex 32)
FLASK_APP=main.py
FLASK_ENV=production
ENV_EOF

# === ØªØ´ØºÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===
source .env
python3 database_setup.py

# === Ø¥Ø¶Ø§ÙØ© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ ===
mkdir -p static/js

cat > static/js/ultimate-tabs-fix.js << 'ULTIMATE_EOF'
// Ultimate Tabs Fix for AI Translator v2.2.4
console.log('ğŸš€ Ultimate Tabs Fix Loading...');

document.addEventListener('DOMContentLoaded', function() {
    let isInitialized = false;
    
    function initializeUltimateTabs() {
        if (isInitialized) return;
        
        console.log('ğŸ”§ Initializing Ultimate Tabs System...');
        
        const categorySelect = document.getElementById('category-select');
        const subcategorySelect = document.getElementById('subcategory-select');
        
        if (!categorySelect || !subcategorySelect) {
            console.warn('âš ï¸ Tab controls not found, retrying in 1 second...');
            setTimeout(initializeUltimateTabs, 1000);
            return;
        }
        
        // Ø®Ø±ÙŠØ·Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª
        const ultimateMapping = {
            'general': {
                name: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©',
                sections: [
                    { id: 'DEFAULT', name: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© / Basic Settings' },
                    { id: 'LANGUAGE', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© / Language Settings' },
                    { id: 'FOOTER', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ / Footer Settings' },
                    { id: 'UI', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© / UI Settings' },
                    { id: 'GENERAL', name: 'Ø¹Ø§Ù… / General' }
                ]
            },
            'ai': {
                name: 'Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
                sections: [
                    { id: 'WHISPER', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Whisper / Whisper Settings' },
                    { id: 'OLLAMA', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ollama / Ollama Settings' },
                    { id: 'GPU', name: 'Ø¥Ø¯Ø§Ø±Ø© GPU / GPU Management' },
                    { id: 'API', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API / API Settings' },
                    { id: 'MODELS', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ / Models Settings' },
                    { id: 'AI', name: 'Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ / AI' }
                ]
            },
            'media': {
                name: 'Ø®ÙˆØ§Ø¯Ù… Ø§Ù„ÙˆØ³Ø§Ø¦Ø·',
                sections: [
                    { id: 'PLEX', name: 'Plex Media Server' },
                    { id: 'JELLYFIN', name: 'Jellyfin Media Server' },
                    { id: 'EMBY', name: 'Emby Media Server' },
                    { id: 'KODI', name: 'Kodi Media Center' },
                    { id: 'RADARR', name: 'Radarr (Ø£ÙÙ„Ø§Ù… / Movies)' },
                    { id: 'SONARR', name: 'Sonarr (Ù…Ø³Ù„Ø³Ù„Ø§Øª / TV Shows)' },
                    { id: 'MEDIA', name: 'ÙˆØ³Ø§Ø¦Ø· / Media' }
                ]
            },
            'system': {
                name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…',
                sections: [
                    { id: 'PATHS', name: 'Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª / File Paths' },
                    { id: 'REMOTE_STORAGE', name: 'Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨Ø¹ÙŠØ¯ / Remote Storage' },
                    { id: 'DATABASE', name: 'Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª / Database' },
                    { id: 'SECURITY', name: 'Ø§Ù„Ø£Ù…Ø§Ù† / Security' },
                    { id: 'SERVER', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… / Server Settings' },
                    { id: 'CORRECTIONS', name: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª / Corrections' },
                    { id: 'SYSTEM', name: 'Ù†Ø¸Ø§Ù… / System' }
                ]
            },
            'development': {
                name: 'Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±',
                sections: [
                    { id: 'DEBUG', name: 'Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ± / Debug Tools' },
                    { id: 'TESTING', name: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± / Testing' },
                    { id: 'DEVELOPMENT', name: 'Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ± / Development Tools' },
                    { id: 'LOGS', name: 'Ø§Ù„Ø³Ø¬Ù„Ø§Øª / Logs' }
                ]
            }
        };
        
        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ DOM
        function findAllAvailableSections() {
            const available = [];
            const allPossibleSections = Object.values(ultimateMapping)
                .flatMap(category => category.sections)
                .map(section => section.id);
            
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ DOM Ø¹Ù† ÙƒÙ„ Ù‚Ø³Ù… Ù…Ø­ØªÙ…Ù„
            allPossibleSections.forEach(sectionId => {
                const selectors = [
                    `#tab-${sectionId}`,
                    `.tab-content[id*="${sectionId}"]`,
                    `[data-section="${sectionId}"]`,
                    `.section-${sectionId}`
                ];
                
                for (const selector of selectors) {
                    const element = document.querySelector(selector);
                    if (element && !available.includes(sectionId)) {
                        available.push(sectionId);
                        break;
                    }
                }
            });
            
            console.log('ğŸ“‹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ DOM:', available);
            return available;
        }
        
        const availableSections = findAllAvailableSections();
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¨Ù‚ÙˆØ© Ù‚ØµÙˆÙ‰
        function ultimateHideAllTabs() {
            const allPossibleSelectors = [
                '.tab-content',
                '[id^="tab-"]',
                '[class*="tab-"]',
                '.form-section',
                '.settings-section',
                '[data-section]'
            ];
            
            allPossibleSelectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    if (element.id && (element.id.startsWith('tab-') || element.id.includes('section'))) {
                        // Ø¥Ø®ÙØ§Ø¡ Ø¨ÙƒÙ„ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ù…ÙƒÙ†Ø©
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        element.style.opacity = '0';
                        element.style.height = '0';
                        element.style.overflow = 'hidden';
                        element.classList.add('hidden');
                        element.setAttribute('hidden', '');
                        element.setAttribute('aria-hidden', 'true');
                    }
                });
            });
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ Ù…Ø­Ø¯Ø¯ Ø¨Ù‚ÙˆØ© Ù‚ØµÙˆÙ‰
        function ultimateShowTab(sectionId) {
            console.log('ğŸ‘ï¸ Ultimate showing section:', sectionId);
            
            ultimateHideAllTabs();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©
            const possibleSelectors = [
                `#tab-${sectionId}`,
                `.tab-content[id="tab-${sectionId}"]`,
                `[data-section="${sectionId}"]`,
                `.section-${sectionId}`,
                `#${sectionId}-section`,
                `.${sectionId}-tab`
            ];
            
            let targetTab = null;
            for (const selector of possibleSelectors) {
                targetTab = document.querySelector(selector);
                if (targetTab) break;
            }
            
            if (targetTab) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø¨ÙƒÙ„ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ù…ÙƒÙ†Ø©
                targetTab.style.display = 'block';
                targetTab.style.visibility = 'visible';
                targetTab.style.opacity = '1';
                targetTab.style.height = 'auto';
                targetTab.style.overflow = 'visible';
                targetTab.classList.remove('hidden');
                targetTab.removeAttribute('hidden');
                targetTab.setAttribute('aria-hidden', 'false');
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ±Ø¹ÙŠØ©
                const childElements = targetTab.querySelectorAll('*');
                childElements.forEach(child => {
                    if (child.style.display === 'none' && !child.classList.contains('always-hidden')) {
                        child.style.display = '';
                    }
                });
                
                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø¹Ù†ØµØ±
                setTimeout(() => {
                    targetTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                console.log('âœ… Ultimate show successful:', sectionId);
                return true;
            } else {
                console.error('âŒ Tab not found with any selector:', sectionId);
                return false;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø´Ø§Ù…Ù„Ø©
        function ultimateUpdateSubcategories(categoryKey) {
            console.log('ğŸ“ Ultimate updating subcategories for:', categoryKey);
            
            // Ù…Ø³Ø­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            subcategorySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ / Choose Subcategory</option>';
            
            const category = ultimateMapping[categoryKey];
            if (!category) {
                console.warn('âŒ Unknown category:', categoryKey);
                subcategorySelect.disabled = true;
                ultimateHideAllTabs();
                return;
            }
            
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
            const availableInCategory = category.sections.filter(section => 
                availableSections.includes(section.id)
            );
            
            if (availableInCategory.length === 0) {
                console.warn('âŒ No available sections for category:', categoryKey);
                subcategorySelect.disabled = true;
                ultimateHideAllTabs();
                return;
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            availableInCategory.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.name;
                subcategorySelect.appendChild(option);
            });
            
            subcategorySelect.disabled = false;
            
            // Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ø¹Ù†ØµØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if (availableInCategory.length > 0) {
                subcategorySelect.value = availableInCategory[0].id;
                ultimateShowTab(availableInCategory[0].id);
            }
            
            console.log('âœ… Ultimate subcategories updated:', availableInCategory.length, 'items');
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        categorySelect.addEventListener('change', function() {
            const selectedCategory = this.value;
            console.log('ğŸ“‚ Category changed to:', selectedCategory);
            ultimateUpdateSubcategories(selectedCategory);
        });
        
        subcategorySelect.addEventListener('change', function() {
            const selectedSection = this.value;
            console.log('ğŸ“„ Subcategory changed to:', selectedSection);
            
            if (selectedSection) {
                ultimateShowTab(selectedSection);
            } else {
                ultimateHideAllTabs();
            }
        });
        
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        window.switchCategory = function() {
            console.log('ğŸ”„ Legacy switchCategory called');
            categorySelect.dispatchEvent(new Event('change'));
        };
        
        window.switchTab = function() {
            console.log('ğŸ”„ Legacy switchTab called');
            subcategorySelect.dispatchEvent(new Event('change'));
        };
        
        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© Ù…Ø­Ø³Ù†Ø©
        const initialCategory = categorySelect.value || 'general';
        if (categorySelect.value !== initialCategory) {
            categorySelect.value = initialCategory;
        }
        ultimateUpdateSubcategories(initialCategory);
        
        isInitialized = true;
        console.log('âœ… Ultimate Tabs System Initialized Successfully!');
        
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        window.ultimateDebugTabs = function() {
            console.log('=== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„Ø© Ù„Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ===');
            console.log('Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', categorySelect.value);
            console.log('Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ:', subcategorySelect.value);
            console.log('Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©:', availableSections);
            
            const allTabs = document.querySelectorAll('[id^="tab-"], .tab-content, [data-section]');
            const visibleTabs = Array.from(allTabs).filter(tab => {
                const computed = window.getComputedStyle(tab);
                return computed.display !== 'none' && 
                       computed.visibility !== 'hidden' && 
                       computed.opacity !== '0' &&
                       !tab.hasAttribute('hidden') && 
                       !tab.classList.contains('hidden');
            });
            
            console.log('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', allTabs.length);
            console.log('Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹:', visibleTabs.map(tab => tab.id || tab.className));
            
            // ÙØ­Øµ DOM Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
            Object.values(ultimateMapping).forEach(category => {
                category.sections.forEach(section => {
                    const found = document.getElementById('tab-' + section.id);
                    if (!found) {
                        console.warn('âŒ Ù‚Ø³Ù… Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ DOM:', section.id);
                    }
                });
            });
            
            return {
                category: categorySelect.value,
                subcategory: subcategorySelect.value,
                availableSections: availableSections,
                totalTabs: allTabs.length,
                visibleTabs: visibleTabs.map(tab => tab.id || tab.className),
                initialized: isInitialized
            };
        };
        
        window.ultimateShowSection = function(sectionId) {
            console.log('ğŸ¯ Force showing section:', sectionId);
            return ultimateShowTab(sectionId);
        };
        
        window.ultimateRefreshTabs = function() {
            console.log('ğŸ”„ Ultimate refreshing tabs system...');
            isInitialized = false;
            setTimeout(initializeUltimateTabs, 500);
        };
        
        window.ultimateFixTabs = function() {
            console.log('ğŸ› ï¸ Ultimate fixing tabs...');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
            const newAvailableSections = findAllAvailableSections();
            availableSections.length = 0;
            availableSections.push(...newAvailableSections);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const currentCategory = categorySelect.value || 'general';
            ultimateUpdateSubcategories(currentCategory);
            
            console.log('âœ… Ultimate tabs fix completed');
        };
    }
    
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯
    setTimeout(initializeUltimateTabs, 1000);
    
    // Ù…Ø±Ø§Ù‚Ø¨ Ù…ØªØ·ÙˆØ± Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    const observer = new MutationObserver(function(mutations) {
        let shouldReinitialize = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) {
                        // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ØªØ¨ÙˆÙŠØ¨
                        const isTab = node.id && node.id.startsWith('tab-') ||
                                     node.className && node.className.includes('tab') ||
                                     node.querySelector && node.querySelector('[id^="tab-"]');
                        
                        if (isTab) {
                            shouldReinitialize = true;
                        }
                    }
                });
            }
        });
        
        if (shouldReinitialize && !isInitialized) {
            console.log('ğŸ”„ DOM changed, reinitializing tabs...');
            setTimeout(initializeUltimateTabs, 500);
        }
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class', 'hidden']
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
    window.addEventListener('resize', function() {
        if (isInitialized) {
            setTimeout(() => {
                const currentSubcategory = document.getElementById('subcategory-select')?.value;
                if (currentSubcategory) {
                    window.ultimateShowSection(currentSubcategory);
                }
            }, 300);
        }
    });
});

console.log('âœ… Ultimate Tabs Fix Loaded Successfully!');
ULTIMATE_EOF

# === ØªØ­Ø¯ÙŠØ« layout.html ===
if [[ -f "templates/layout.html" ]]; then
    # Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
    sed -i '/tabs-fix\.js/d' templates/layout.html
    sed -i '/final-tabs-fix\.js/d' templates/layout.html
    sed -i '/comprehensive-tabs-fix\.js/d' templates/layout.html
    
    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    if ! grep -q "ultimate-tabs-fix.js" templates/layout.html; then
        sed -i 's|</body>|    <script src="{{ url_for('\''static'\'', filename='\''js/ultimate-tabs-fix.js'\'') }}"></script>\n</body>|' templates/layout.html
        echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« layout.html Ø¨Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"
    fi
fi

# === Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø© systemd ===
sudo tee /etc/systemd/system/ai-translator.service > /dev/null << 'SERVICE_EOF'
[Unit]
Description=AI Translator Service - Arabic Subtitle Translation System
Documentation=https://github.com/AbdelmonemAwad/ai-translator
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=eg2
Group=eg2
WorkingDirectory=/home/eg2/ai-translator
Environment=PATH=/home/eg2/ai-translator/venv/bin
EnvironmentFile=/home/eg2/ai-translator/.env
ExecStart=/home/eg2/ai-translator/venv/bin/gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 300 --max-requests 1000 --preload main:app
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/home/eg2/ai-translator
ProtectHome=read-only

[Install]
WantedBy=multi-user.target
SERVICE_EOF

# === Ø¥Ø¹Ø¯Ø§Ø¯ Nginx Ù…Ø­Ø³Ù† ===
sudo tee /etc/nginx/sites-available/ai-translator > /dev/null << 'NGINX_EOF'
# AI Translator Nginx Configuration
# Optimized for media processing and file uploads

server {
    listen 80;
    server_name _;
    
    # Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„ÙˆÙ‚Øª
    client_max_body_size 5G;
    client_body_timeout 600s;
    client_header_timeout 300s;
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
    proxy_connect_timeout 300s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    proxy_buffering off;
    proxy_request_buffering off;
    
    # Ø¶ØºØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_cache_bypass $http_upgrade;
    }
    
    # Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
    location /static/ {
        alias /home/eg2/ai-translator/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        
        # Ø¶ØºØ· Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
        location ~* \.(css|js)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            gzip_static on;
        }
        
        # Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ±
        location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    location /upload {
        client_max_body_size 10G;
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_request_buffering off;
    }
    
    # Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ \.(env|py|pyc|pyo|db|sqlite|log)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Ø³Ø¬Ù„Ø§Øª Ù…Ø®ØµØµØ©
    access_log /var/log/nginx/ai-translator.access.log;
    error_log /var/log/nginx/ai-translator.error.log warn;
    
    # ØµÙØ­Ø© Ø®Ø·Ø£ Ù…Ø®ØµØµØ©
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /var/www/html;
        internal;
    }
}
NGINX_EOF

# === ØªÙØ¹ÙŠÙ„ Nginx ===
sudo ln -sf /etc/nginx/sites-available/ai-translator /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t

# === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙƒÙŠØ§Øª ===
sudo chown -R eg2:eg2 /home/eg2/ai-translator

# === Ø¨Ø¯Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ===
sudo systemctl daemon-reload
sudo systemctl enable ai-translator
sudo systemctl restart postgresql
sudo systemctl restart nginx
sudo systemctl start ai-translator

# === Ø§Ù†ØªØ¸Ø§Ø± ÙˆÙØ­Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===
echo "â³ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..."
sleep 8

echo "ğŸ“Š ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª:"
echo "======================"
services=("ai-translator" "nginx" "postgresql")
for service in "${services[@]}"; do
    if systemctl is-active --quiet $service; then
        echo "âœ… $service: ÙŠØ¹Ù…Ù„"
    else
        echo "âŒ $service: Ù…ØªÙˆÙ‚Ù"
        echo "   Ø¢Ø®Ø± Ø³Ø¬Ù„Ø§Øª:"
        sudo journalctl -u $service --no-pager -n 3
    fi
done

echo ""
echo "ğŸ”Œ ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ°:"
echo "==============="
for port in 80 5000 5432; do
    if ss -tlnp | grep -q ":$port "; then
        echo "âœ… Ù…Ù†ÙØ° $port: Ù…ÙØªÙˆØ­"
    else
        echo "âŒ Ù…Ù†ÙØ° $port: Ù…ØºÙ„Ù‚"
    fi
done

echo ""
echo "ğŸŒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:"
echo "=================="
local_ip=$(hostname -I | awk '{print $1}' | tr -d '[:space:]')

# Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø©
if curl -s --connect-timeout 5 http://localhost:5000/ | grep -q "title\|html"; then
    echo "âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³ØªØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 5000"
else
    echo "âŒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 5000"
fi

# Ø§Ø®ØªØ¨Ø§Ø± Nginx
if curl -s --connect-timeout 5 http://localhost/ | grep -q "title\|html"; then
    echo "âœ… Nginx ÙŠØ³ØªØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 80"
else
    echo "âŒ Nginx Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 80"
fi

# Ø§Ø®ØªØ¨Ø§Ø± ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
if curl -s --connect-timeout 5 http://localhost/login | grep -q "login\|ØªØ³Ø¬ÙŠÙ„"; then
    echo "âœ… ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªØ¹Ù…Ù„"
else
    echo "âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"
fi

echo ""
echo "ğŸ‰ ØªÙ… ØªØ«Ø¨ÙŠØª AI Translator v2.2.4 Ø¨Ù†Ø¬Ø§Ø­!"
echo "=========================================="
echo ""
echo "ğŸŒ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØµÙˆÙ„:"
echo "   Ù…Ø­Ù„ÙŠ: http://localhost"
echo "   Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©: http://$local_ip"
echo "   Ø®Ø§Ø±Ø¬ÙŠ: http://5.31.55.179"
echo ""
echo "ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:"
echo "   Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin"
echo "   ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: your_strong_password"
echo ""
echo "ğŸ“ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: /home/eg2/ai-translator"
echo "ğŸ—„ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: PostgreSQL (ai_translator)"
echo ""
echo "ğŸ”§ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ÙÙŠØ¯Ø©:"
echo "   sudo systemctl status ai-translator    # Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
echo "   sudo systemctl restart ai-translator   # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„"
echo "   sudo journalctl -u ai-translator -f    # Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª"
echo "   sudo systemctl status nginx            # Ø­Ø§Ù„Ø© Nginx"
echo "   sudo systemctl status postgresql       # Ø­Ø§Ù„Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
echo ""
echo "ğŸ¯ Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:"
echo "   âœ… Ù†Ø¸Ø§Ù… ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ…ØªØ·ÙˆØ± (Ultimate)"
echo "   âœ… Ø±Ø¨Ø· Ø´Ø§Ù…Ù„ Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…"
echo "   âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø£Ø®Ø·Ø§Ø¡ DOM Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©"
echo "   âœ… ÙˆØ¸Ø§Ø¦Ù ØªØ´Ø®ÙŠØµÙŠØ© ÙˆØ¥ØµÙ„Ø§Ø­ ÙÙˆØ±ÙŠ Ø´Ø§Ù…Ù„Ø©"
echo "   âœ… ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø©"
echo "   âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø°ÙƒÙŠØ©"
echo ""
echo "ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:"
echo "   - Ù„ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„: ultimateDebugTabs()"
echo "   - Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø¨Ø§Ù„Ù‚ÙˆØ©: ultimateShowSection('Ø§Ø³Ù…_Ø§Ù„Ù‚Ø³Ù…')"
echo "   - Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…: ultimateRefreshTabs()"
echo "   - Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: ultimateFixTabs()"
echo ""
echo "âœ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…ÙƒØªÙ…Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª!"

# === Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ===
echo ""
echo "ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª:"
echo "===================================="
echo "1. Ø§ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: http://$local_ip"
echo "2. Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ù€: admin / your_strong_password"
echo "3. Ø§Ø°Ù‡Ø¨ Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"
echo "4. Ø§Ø¶ØºØ· F12 ÙˆØ´ØºÙ„ ÙÙŠ Console:"
echo "   ultimateDebugTabs()"
echo "5. Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©"
echo ""
echo "âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¬Ø§Ù‡Ø²Ø© ÙˆÙ…Ø·Ø¨Ù‚Ø©!"
ULTIMATE_EOF